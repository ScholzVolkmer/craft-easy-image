{% macro srcset(image, transformSet) %}
  srcset=
    "{% for transform in transformSet.transforms %}
      {{ image[0].getUrl(transform) }} {{ transform.width }}w,
    {% endfor %}"
{% endmacro %}

<picture>
  {# Output sources for main format #}
  {% for image in images %}
    {% set transformSet = settings.transformSets[image[1]] %}
    {% if transformSet.format is not same as(transformSet.fallbackFormat) %} {# if these are identical, the source will be covered in the next images loop #}
      <source
        type="image/{{ transformSet.format }}"
        {{ _self.srcset(image, transformSet) }}
        {% if not loop.last %}
          media="(min-width: {{ image[2]|default(0) }}px)"
        {% endif %}
      />
    {% endif %}
  {% endfor %}
  {# Output sources for fallback format #}
  {% for image in images %}
    {% set transformSet = settings.transformSets[image[1]] %}
    {% do transformSet.fallback() %} {# updates format of this transform set to the fallback #}
    {% if not loop.last %}
      <source
        type="image/{{ transformSet.format }}"
        {{ _self.srcset(image, transformSet) }}
        media="(min-width: {{ image[2]|default(0) }}px)"
      />
    {% else %} {# Fallback img tag in place of final source #}
      <img
        {{ attr(attributes) }}
        {# default to first transform for required src attr #}
        src="{{ image[0].getUrl(transformSet.transforms[0]) }}"
        {{ _self.srcset(image, transformSet) }}
        alt="{{ image[0].alt ?? image[0].title }}"
        {% if eager != true %}loading="lazy"{% endif %}
      />
    {% endif %}
  {% endfor %}
</picture>
