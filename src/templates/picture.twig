{% macro srcset(image, transformSet) %}
  srcset="
    {% for transform in transformSet.transforms %}
      {{ image[0].getUrl(transform) }} {{ transform.width }}w,
    {% endfor %}
  "
  {# Set height and width based on the set's aspect ratio;
     these numbers are just used to calculate aspect ratio to prevent CLS.
     Defaults to 4/3 if no aspect ratio is set. #}
  height="144"
  width="{{ transformSet.aspectRatio ? (144 * transformSet.aspectRatio)|round : 192}}"
{% endmacro %}

<picture>
  {# Output sources for main format #}
  {% for image in images %}
    {% set transformSet = settings.transformSets[image[1]] %}
    {% if transformSet.fallbackFormat is defined and transformSet.format is not same as(transformSet.fallbackFormat) %} {# if these are identical, the source will be covered in the next images loop #}
      <source
        type="image/{{ transformSet.format == 'jpg' ? 'jpeg' : transformSet.format }}"
        {{ _self.srcset(image, transformSet) }}
        {% if not loop.last %}
          media="(min-width: {{ image[2]|default(0) }}px)"
        {% endif %}
      />
    {% endif %}
  {% endfor %}
  {# Output sources for fallback format #}
  {% for image in images %}
    {% set transformSet = settings.transformSets[image[1]] %}
    {% do transformSet.fallback() %} {# updates format of this transform set to the fallback #}
    {% if not loop.last %}
      <source
        type="image/{{ transformSet.format }}"
        {{ _self.srcset(image, transformSet) }}
        media="(min-width: {{ image[2]|default(0) }}px)"
      />
    {% else %} {# Fallback img tag in place of final source #}
      <img
        {{ attr(attributes) }}
        {# default to first transform for required src attr #}
        src="{{ image[0].getUrl(transformSet.transforms[0]) }}"
        {{ _self.srcset(image, transformSet) }}
        alt="{{ image[0].alt ?? image[0].title }}"
        {% if eager != true %}loading="lazy"{% endif %}
      />
    {% endif %}
  {% endfor %}
</picture>
